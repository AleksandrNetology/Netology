## Операционные системы. Лекция 2.

#### Оценка потребления ресурсов

Хорошая статья на тему оценки производительности [здесь](https://netflixtechblog.com/linux-performance-analysis-in-60-000-milliseconds-accc10403c55).

Краткая выдержка из неё по командам:

`uptime` — текущий аптайм, `Load Average` за 1, 5 и 15 минут соответственно;

`dmesg` — логи ядра, здесь могут быть ошибки, которые говорят о проблемах производительности (`oomkiller`, деградация дисковой подсистемы, сети и др.)\
Лучше использовать с ключом `-Т` для адекватного отображения времени: `dmesg -T`.

	vagrant@vagrant:~$ dmesg
	[   46.052590] 13:14:10.463798 main     Executable: /opt/VBoxGuestAdditions-6.1.30/sbin/VBoxService
               13:14:10.463799 main     Process ID: 831
               13:14:10.463799 main     Package type: LINUX_64BITS_GENERIC
	[   46.058178] 13:14:10.469384 main     6.1.30 r148432 started. Verbose level = 0
	[   46.068606] 13:14:10.479786 main     vbglR3GuestCtrlDetectPeekGetCancelSupport: Supported (#1)

Тоже самое но в адекватном виде:

	vagrant@vagrant:~$ dmesg -T
	[Tue Feb 15 13:14:10 2022] 13:14:10.463798 main     Executable: /opt/VBoxGuestAdditions-6.1.30/sbin/VBoxService
                           13:14:10.463799 main     Process ID: 831
                           13:14:10.463799 main     Package type: LINUX_64BITS_GENERIC
	[Tue Feb 15 13:14:10 2022] 13:14:10.469384 main     6.1.30 r148432 started. Verbose level = 0
	[Tue Feb 15 13:14:10 2022] 13:14:10.479786 main     vbglR3GuestCtrlDetectPeekGetCancelSupport: Supported (#1)


`vmstat <interval>` — общие метрики производительности в одном месте, выводятся на терминал раз в интервал времени <interval> в секундах:\
- r, b — количество процессов в состоянии R и D соответственно;\
- swpd, free, buff, cache — потребление памяти в системе: файл подкачки, свободной и выделенной под буферы и кеш;\
- bi, bo — количество блоков прочитанных и записанных на диск;\
- us, sy, id, wa — процент времени, когда CPU был утилизирован под `userspace`, `kernelspace` задачи, когда он не выполнял никакой работы или когда задачи ожидали ввода/вывод.

	vagrant@vagrant:~$ vmstat 1
	procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
	r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
	1  0      0 1525840  42260 339852    0    0    66     6   19   79  0  0 100  0  0
	0  0      0 1525832  42260 339852    0    0     0     0   32   52  0  0 100  0  0
	0  0      0 1525832  42260 339852    0    0     0     0   31   53  0  0 100  0  0
	0  0      0 1525832  42260 339852    0    0     0     0   35   49  0  0 100  0  0

Причём первая строчка вывода - это среднее значение меток за всё время работы системы.
Если выводить данные каждую секунду, то можно отловить какие-то пики в работе системы т.е. неравномерную нагрузку.

Тоже самое, но память в мегабайтах:\
	vagrant@vagrant:~$ vmstat -S M 1
	procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
	r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
	1  0      0   1490     41    331    0    0    54     5   18   68  0  0 100  0  0
	0  0      0   1490     41    331    0    0     0     0   26   36  0  0 100  0  0
	0  0      0   1490     41    331    0    0     0     0   27   41  0  0 100  0  0



`mpstat` — утилизация процессора в разрезе ядер, с помощью которой можно увидеть дисбаланс распределения нагрузки по ядрам;\
`pidstat` — раз в интервал выводит полезные метрики утилизации ресурсов по процессам (CPU, RAM, IO);\
- -t показывает треды;
- -d показывает метрики ввода/вывода;
- -r утилизация памяти;
- -u утилизация процессора.

`iostat` — метрики подсистемы ввода вывода в разрезе блочных устройств:\
- r/s, w/s количество запросов чтения и записи к устройству;\
- rkB/s, wkB/s количество байт считанных или записанных;\
- avgrq-sz, avgqu-sz средний размер запроса в байтах и среднее количество запросов в очереди на обслуживание;\
- await среднее время обслуживание запроса в миллисекундах, включая ожидание в очереди.

`free` — использование памяти в системе.

`sar` — может показывать раличные метрики производительности:\
- -n DEV, -n EDEV утилизация сетевых интерфейсов и дропы пакетов на них;\
- -n TCP, -n ETCP, -n UDP метрики TCP и UDP протоколов (кол-во соединений в секунды, ретрансмиты и др.);\
- -B метрики использования page cache;\
- -b, -d метрики IO по устройствам;\
- -F метрики от смонтированных файловых систем;\
Эта утилита не входит в стандартную поставку, недо установить отдельно: пакет `sysstat`.





#### Ядро и модули

#### Система инициализации: systemd



